---
title: "Itâ€™s Mutual: Continuity and Change of  Reciprocal Discussions in Teaching-Related Subreddits"
author: "K. Bret Staudt Willet & Jeffrey P. Carpenter"
date: "01/15/2020"
output:
  pdf_document:
    toc: yes
  html_document:
    float_toc: yes
    toc: yes
---

# Get set up

This section loads the data and packages and starts to process the data, but doesn't calculate any statistics or create any results.

1. Load packages

```{r, include=FALSE}
library(knitr)
library(kableExtra)
library(tidyverse)  # for data manipulation
library(anytime)
library(lubridate)  # for working with dates
library(igraph)  # for processing the social network
library(ggraph)  # for visualizing the social network
```

2. Set up settings for sharing 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
usethis::use_git_ignore(c("*.csv", "*.rds"))
```

3. Set timeframe

```{r timeframe, include=FALSE}
date_start <- as_datetime("2016-01-01 05:00:00 UTC") %>% 
        ymd_hms() %>%
        with_tz(tzone="US/Eastern")
date_end <- as_datetime("2019-07-01 03:59:59 UTC") %>% 
        ymd_hms() %>%
        with_tz(tzone="US/Eastern")
```

4. Load subreddit posts

```{r posts, include=FALSE}
posts_teachers <- read.csv("data/r-teachers-posts.csv", 
                            header=TRUE, 
                            colClasses='character'
                            ) %>%
        as.data.frame() %>%
        rename(post_id = id, 
               post_author = author,
               post_voting_score = score,
               post_text = selftext
               ) %>%
        mutate(post_date_time = created_utc %>% 
                       as.numeric() %>% 
                       anytime(asUTC=TRUE) %>% 
                       as_datetime %>%
                       ymd_hms() %>%
                       with_tz(tzone="US/Eastern"),
               post_voting_score = post_voting_score %>% as.numeric(),
               post_year = year(post_date_time),
               post_semester = semester(post_date_time, with_year=TRUE),
               post_word_count = str_count(title, "\\s+") + 
                       str_count(post_text, "\\s+") + 2
               ) %>%
        distinct(post_id, .keep_all = TRUE) %>%
        filter(post_date_time >= date_start,
               post_date_time <= date_end,
               post_id != "",
               !is.na(post_id),
               post_author != "",
               post_author != "[deleted]",
               post_text != "[deleted]",
               post_text != "[removed]"
               )

posts_education <- read.csv("data/r-education-posts.csv", 
                            header=TRUE, 
                            colClasses='character'
                            ) %>%
        as.data.frame() %>%
        rename(post_id = id, 
               post_author = author,
               post_voting_score = score,
               post_text = selftext
               ) %>%
        mutate(post_date_time = created_utc %>% 
                       as.numeric() %>% 
                       anytime(asUTC=TRUE) %>% 
                       as_datetime %>%
                       ymd_hms() %>%
                       with_tz(tzone="US/Eastern"),
               post_voting_score = post_voting_score %>% as.numeric(),
               post_year = year(post_date_time),
               post_semester = semester(post_date_time, with_year=TRUE),
               post_word_count = str_count(title, "\\s+") + 
                       str_count(post_text, "\\s+") + 2
               ) %>%
        distinct(post_id, .keep_all = TRUE) %>%
        filter(post_date_time >= date_start,
               post_date_time <= date_end,
               post_id != "",
               !is.na(post_id),
               post_author != "",
               post_author != "[deleted]",
               post_text != "[deleted]",
               post_text != "[removed]"
               )
```

5. Load subreddit responses

```{r responses, include=FALSE}
responses_teachers <- read.csv("data/r-teachers-responses.csv", 
                            header=TRUE, 
                            colClasses='character'
                            ) %>%
        as.data.frame() %>% 
        rename(response_id = id, 
               response_author = author,
               response_voting_score = score,
               response_text = body) %>%
        mutate(thread_id = str_remove(link_id, pattern="t[0-9]_"),
               parent_id = str_remove(parent_id, pattern="t[0-9]_"),
               response_date_time = created_utc %>% 
                       as.numeric() %>% 
                       anytime(asUTC=TRUE) %>% 
                       as_datetime %>%
                       ymd_hms() %>%
                       with_tz(tzone="US/Eastern"),
               post_id = thread_id,
               response_voting_score = response_voting_score %>% as.numeric(),
               response_year = year(response_date_time),
               response_semester = semester(response_date_time, with_year=TRUE),
               response_word_count = str_count(response_text, "\\s+") + 1
               ) %>% 
        distinct(response_id, .keep_all = TRUE) %>%
        filter(response_date_time >= date_start,
               response_date_time <= date_end,
               response_id != "",
               !is.na(response_id),
               response_author != "",
               response_author != "[deleted]",
               response_text != "[deleted]",
               response_text != "[removed]"
               )

responses_education <- read.csv("data/r-education-responses.csv", 
                            header=TRUE, 
                            colClasses='character'
                            ) %>%
        as.data.frame() %>% 
        rename(response_id = id, 
               response_author = author,
               response_voting_score = score,
               response_text = body) %>%
        mutate(thread_id = str_remove(link_id, pattern="t[0-9]_"),
               parent_id = str_remove(parent_id, pattern="t[0-9]_"),
               response_date_time = created_utc %>% 
                       as.numeric() %>% 
                       anytime(asUTC=TRUE) %>% 
                       as_datetime %>%
                       ymd_hms() %>%
                       with_tz(tzone="US/Eastern"),
               post_id = thread_id,
               response_voting_score = response_voting_score %>% as.numeric(),
               response_year = year(response_date_time),
               response_semester = semester(response_date_time, with_year=TRUE),
               response_word_count = str_count(response_text, "\\s+") + 1
               ) %>% 
        distinct(response_id, .keep_all = TRUE) %>%
        filter(response_date_time >= date_start,
               response_date_time <= date_end,
               response_id != "",
               !is.na(response_id),
               response_author != "",
               response_author != "[deleted]",
               response_text != "[deleted]",
               response_text != "[removed]"
               )
```

6. Create a merged dataframe of posts and responses for both subreddits.

```{r merged, include=FALSE}
merged_teachers <- posts_teachers %>% 
        left_join(responses_teachers, by=c('post_id')) %>%
        mutate(self_response = ifelse(is.na(response_author), 
                                      FALSE,
                                      ifelse(post_author==response_author, TRUE, FALSE)
                                      )
               ) %>%
        group_by(post_id) %>%
        mutate(n_responses = length(which(!is.na(response_id))),
               n_self_responses = length(which(self_response)), 
               p_self_responses = ifelse(n_responses==0, 
                                         0, 
                                         round(100 * n_self_responses / n_responses, 2)
                                         )
               ) %>%
        ungroup()

merged_education <- posts_education %>% 
        left_join(responses_education, by=c('post_id')) %>%
        mutate(self_response = ifelse(is.na(response_author), 
                                      FALSE,
                                      ifelse(post_author==response_author, TRUE, FALSE)
                                      )
               ) %>%
        group_by(post_id) %>%
        mutate(n_responses = length(which(!is.na(response_id))),
               n_self_responses = length(which(self_response)), 
               p_self_responses = ifelse(n_responses==0, 
                                         0, 
                                         round(100 * n_self_responses / n_responses, 2)
                                         )
               ) %>%
        ungroup()
```

# Analysis and Results

## Figure 1. Contributions to r/Teachers and r/education each day from January 1, 2016 through June 30, 2019

```{r, include=TRUE, echo=FALSE}
n_months <- (date_end - date_start) %>% time_length(unit="months")

n_posts_overall_teachers <- length(unique(merged_teachers$post_id))
n_posts_overall_education <- length(unique(merged_education$post_id))

n_responses_overall_teachers <- merged_teachers %>%
        filter(., !is.na(response_id)) %>%
        pull(response_id) %>%
        unique() %>%
        length()
n_responses_overall_education <- merged_education %>%
        filter(., !is.na(response_id)) %>%
        pull(response_id) %>%
        unique() %>%
        length()

n_contributions_overall_teachers <- n_posts_overall_teachers +
        n_responses_overall_teachers
n_contributions_overall_education <- n_posts_overall_education +
        n_responses_overall_education

n_posters_overall_teachers <- length(unique(merged_teachers$post_author))
n_posters_overall_education <- length(unique(merged_education$post_author))

n_responders_overall_teachers <- merged_teachers %>%
        filter(., !is.na(response_author)) %>%
        pull(response_author) %>%
        unique() %>%
        length()
n_responders_overall_education <- merged_education %>%
        filter(., !is.na(response_author)) %>%
        pull(response_author) %>%
        unique() %>%
        length()

n_contributors_overall_teachers <- merged_teachers %>%
        c(pull(., post_author), pull(., response_author)) %>%
        unique() %>%
        length() -1  ## to account for the NA response_author
n_contributors_overall_education <- merged_education %>%
        c(pull(., post_author), pull(., response_author)) %>%
        unique() %>%
        length() -1  ## to account for the NA response_author


paste0("From the r/Teachers subreddit, we collected ", n_contributions_overall_teachers,  " contributions from ", n_contributors_overall_teachers, " contributors"); paste0("dated between ", date(date_start), " and ", date(date_end), " (", round(n_months, 2), " months),"); paste0("a total of ", n_posts_overall_teachers, " posts and ", n_responses_overall_teachers, " responses to those posts."); paste0("From the r/education subreddit during the same time period, we collected ", n_contributions_overall_education,  " contributions from ", n_contributors_overall_education, " contributors"); paste0("a total of ", n_posts_overall_education, " posts and ", n_responses_overall_education, " responses to those posts.")
```

```{r contributions-over-time-comparison, include=TRUE, echo=FALSE}
to_plot_posts_teachers <- posts_teachers$post_date_time %>% 
        floor_date("day") %>% 
        as_date() %>%
        table() %>% 
        as.data.frame() %>%
        rename(day = ".",
               n = Freq) %>%
        mutate(day = as_date(day),
               type = "post",
               subreddit = "teachers") %>%
        filter((day >= date_start) & (day <= date_end))
to_plot_responses_teachers <- responses_teachers$response_date_time %>% 
        floor_date("day") %>% 
        as_date() %>%
        table() %>% 
        as.data.frame() %>%
        rename(day = ".",
               n = Freq) %>%
        mutate(day = as_date(day),
               type = "response",
               subreddit = "teachers") %>%
        filter((day >= date_start) & (day <= date_end))
to_plot_posts_education <- posts_education$post_date_time %>% 
        floor_date("day") %>% 
        as_date() %>%
        table() %>% 
        as.data.frame() %>%
        rename(day = ".",
               n = Freq) %>%
        mutate(day = as_date(day),
               type = "post",
               subreddit = "education") %>%
        filter((day >= date_start) & (day <= date_end))
to_plot_responses_education <- responses_education$response_date_time %>% 
        floor_date("day") %>% 
        as_date() %>%
        table() %>% 
        as.data.frame() %>%
        rename(day = ".",
               n = Freq) %>%
        mutate(day = as_date(day),
               type = "response",
               subreddit = "education") %>%
        filter((day >= date_start) & (day <= date_end))

to_plot <- to_plot_posts_teachers %>% 
        full_join(to_plot_responses_teachers, by = c("subreddit", "day", "type", "n")) %>%
        full_join(to_plot_posts_education, by = c("subreddit", "day", "type", "n")) %>%
        full_join(to_plot_responses_education, by = c("subreddit", "day", "type", "n")) %>%
        mutate(subreddit = as.factor(subreddit),
               type = as.factor(type)
               )

ggplot(data = to_plot, mapping = aes(x=day, y=n, color=subreddit, shape=type)) +
        geom_point(size = 3, alpha=.8) + 
        scale_shape_manual(values = c(17, 3)) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        geom_smooth(method='lm', se=FALSE, size=2) +
        scale_y_continuous(trans='log10') +
        xlab(NULL) +
        ylab("Number of Contributions") +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "gray90"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=24, family='serif'),
              legend.position='bottom',
              legend.box = 'vertical',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit', shape='Type of Contribution:')
```

```{r, include=FALSE}
#ggsave("output/contributions-over-time-comparison.png", width = 16, height = 9)
```

```{r regression-line, include=TRUE, echo=FALSE}
## Print the slopes of the linear regressions:
post_fit_teachers <- to_plot %>% 
        filter(type=='post', subreddit=='teachers') %>% 
        lm(n ~ day, data = .)
post_slope_teachers <- post_fit_teachers$coefficients[[2]] %>% round(2)
post_slope_pval_teachers <- summary(post_fit_teachers)$coef[2,4] %>% round(8)

response_fit_teachers <- to_plot %>% 
        filter(type=='response', subreddit=='teachers') %>% 
        lm(n ~ day, data = .)
response_slope_teachers <- response_fit_teachers$coefficients[[2]] %>% round(2)
response_slope_pval_teachers <- summary(response_fit_teachers)$coef[2,4] %>% round(8)

post_fit_education <- to_plot %>% 
        filter(type=='post', subreddit=='education') %>% 
        lm(n ~ day, data = .)
post_slope_education <- post_fit_education$coefficients[[2]] %>% round(2)
post_slope_pval_education <- summary(post_fit_education)$coef[2,4] %>% round(8)

response_fit_education <- to_plot %>% 
        filter(type=='response', subreddit=='education') %>% 
        lm(n ~ day, data = .)
response_slope_education <- response_fit_education$coefficients[[2]] %>% round(2)
response_slope_pval_education <- summary(response_fit_education)$coef[2,4] %>% round(8)

paste0("For the r/Teachers subreddit, the slope of the `post` linear regression is ", post_slope_teachers, " (p=", post_slope_pval_teachers, "),"); paste0("and the slope of the `response` linear regression is ", response_slope_teachers, " (p=", response_slope_pval_teachers, ")."); paste0("For the r/education subreddit, the slope of the `post` linear regression is ", post_slope_education, " (p=", post_slope_pval_education, "),"); paste0("and the slope of the `response` linear regression is ", response_slope_education, " (p=", response_slope_pval_education, ")."); 
```

## Figure 2. Contributors to r/Teachers and r/education over Time

```{r table1, include=TRUE, echo=FALSE}
## have to subtract 1 to account for NA rows for n_responders and n_contributors
table1_teachers <- merged_teachers %>%
        group_by(post_semester) %>% 
        summarize(n_posters_teachers = length(unique(post_author)),
                  n_responders_teachers = length(unique(response_author)) - 1, 
                  n_contributors_teachers = length(unique(c(post_author, 
                                                            response_author))) - 1
                  ) %>%
        rename(semester=post_semester)
table1_education <- merged_education %>%
        group_by(post_semester) %>% 
        summarize(n_posters_education = length(unique(post_author)),
                  n_responders_education = length(unique(response_author)) - 1, 
                  n_contributors_education = length(unique(c(post_author, 
                                                            response_author))) - 1
                  ) %>%
        rename(semester=post_semester)
table1 <- table1_teachers %>% full_join(table1_education, by='semester') %>%
        select(semester, 
               n_contributors_teachers, n_contributors_education,
               n_posters_teachers, n_posters_education,
               n_responders_teachers, n_responders_education)
table1_kable <- table1 %>% 
        knitr::kable(align='c',
                     col.names=c("Year", 
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation")
                     ) %>% 
        kable_styling(c("striped", "bordered")) %>%
        add_header_above(c(" " = 1, "Contributors" = 2, "Posters" = 2, "Responders" = 2))
#save_kable(table1_kable, "output/table1.png")  # requires webshot::install_phantomjs()
table1_kable
```

```{r individual-contributions, include=TRUE, echo=FALSE}
tidy_table1 <- table1 %>% 
        pivot_longer(cols = -semester, 
                     names_to = c("type", "subreddit"),
                     names_pattern = "n_(.*)_(.*)",
                     values_to = "count"
                     ) %>%
        mutate(date_bin = ifelse(semester==2016.1, "2016-Jan-Jun",
                                 ifelse(semester==2016.2, "2016-Jul-Dec",
                                        ifelse(semester==2017.1, "2017-Jan-Jun",
                                               ifelse(semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               )

ggplot(data = tidy_table1, 
       mapping = aes(x=date_bin, y=count, 
                     color=subreddit,
                     group=interaction(type, subreddit)
                     )
       ) +
        geom_point(size = 12, alpha = .8, aes(shape=type)) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        scale_shape_manual(values = c(19, 17, 15)) +
        xlab(NULL) +
        ylab("Number of Contributors") +
        ylim(0, 20000) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box = 'vertical',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:', shape='Type of Contribution:')
```

```{r, include=FALSE}
#ggsave("output/individual-contributions.png", width = 16, height = 9)
```

## Figure 3. Degree of Contribution to r/Teachers and r/education over Time

```{r, include=TRUE, echo=FALSE}
n_multiple_posts_teachers <- merged_teachers %>% 
        group_by(post_semester) %>% 
        count(post_author) %>%
        filter(n > 1) %>% 
        summarize(multiple_posts_teachers = length(n)) %>%
        rename(semester = post_semester)
n_multiple_responses_teachers <- merged_teachers %>% 
        filter(., !is.na(response_author)) %>%
        group_by(post_semester) %>% 
        count(response_author) %>%
        filter(n > 1) %>% 
        summarize(multiple_responses_teachers = length(n)) %>%
        rename(semester = post_semester)
n_self_response_teachers <- merged_teachers %>% 
        filter(., !is.na(response_author)) %>%
        mutate(self_response_numeric = ifelse(self_response, 1, 0)) %>%
        group_by(post_author, post_semester) %>%
        summarize(self_responses_by_poster = sum(self_response)) %>%
        filter(self_responses_by_poster > 0) %>%
        group_by(post_semester) %>%
        summarize(n_with_some_self_responses_teachers = length(self_responses_by_poster)) %>%
        rename(semester = post_semester)
n_multiple_posts_education <- merged_education %>% 
        group_by(post_semester) %>% 
        count(post_author) %>%
        filter(n > 1) %>% 
        summarize(multiple_posts_education = length(n)) %>%
        rename(semester = post_semester)
n_multiple_responses_education <- merged_education %>% 
        filter(., !is.na(response_author)) %>%
        group_by(post_semester) %>% 
        count(response_author) %>%
        filter(n > 1) %>% 
        summarize(multiple_responses_education = length(n)) %>%
        rename(semester = post_semester)
n_self_response_education <- merged_education %>% 
        filter(., !is.na(response_author)) %>%
        mutate(self_response_numeric = ifelse(self_response, 1, 0)) %>%
        group_by(post_author, post_semester) %>%
        summarize(self_responses_by_poster = sum(self_response)) %>%
        filter(self_responses_by_poster > 0) %>%
        group_by(post_semester) %>%
        summarize(n_with_some_self_responses_education = length(self_responses_by_poster)) %>%
        rename(semester = post_semester)

table2 <- table1 %>% 
        full_join(n_multiple_posts_teachers) %>% 
        full_join(n_multiple_posts_education) %>% 
        full_join(n_multiple_responses_teachers) %>%
        full_join(n_multiple_responses_education) %>% 
        full_join(n_self_response_teachers) %>%
        full_join(n_self_response_education) %>%
        mutate(p_multiple_posts_teachers = round(100 * multiple_posts_teachers / 
                                                         n_posters_teachers, 2),
               p_multiple_posts_education = round(100 * multiple_posts_education / 
                                                          n_posters_education, 2),
               p_multiple_responses_teachers = round(100 * multiple_responses_teachers / 
                                                             n_responders_teachers, 2),
               p_multiple_responses_education = round(100 * multiple_responses_education / 
                                                              n_responders_education, 2), 
               p_self_responses_teachers = round(100 * n_with_some_self_responses_teachers / 
                                                        n_responders_teachers, 2),
               p_self_responses_education = round(100 * n_with_some_self_responses_education / 
                                                          n_responders_education, 2)
               ) %>%
        select(semester,
               p_multiple_posts_teachers, p_multiple_posts_education,
               p_multiple_responses_teachers, p_multiple_responses_education,
               p_self_responses_teachers, p_self_responses_education)

table2_kable <- table2 %>% 
        knitr::kable(align='c',
                     col.names=c("Year", 
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation")
                     ) %>% 
        kable_styling(c("striped", "bordered")) %>%
        add_header_above(c(" " = 1, "Multiple Posts Proportion" = 2, 
                           "Multiple Responses Proportion" = 2, "Self-Responses Proportion" = 2))
#save_kable(table2_kable, "output/table2.png")  # requires webshot::install_phantomjs()
table2_kable
```

```{r degree-of-contribution, include=TRUE, echo=FALSE}
tidy_table2 <- table2 %>% 
        pivot_longer(cols = -semester, 
                     names_to = c("type", "subreddit"),
                     names_pattern = "p_(.*)_(.*)",
                     values_to = "proportion"
                     ) %>%
        mutate(date_bin = ifelse(semester==2016.1, "2016-Jan-Jun",
                                 ifelse(semester==2016.2, "2016-Jul-Dec",
                                        ifelse(semester==2017.1, "2017-Jan-Jun",
                                               ifelse(semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               )
ggplot(data = tidy_table2, 
       mapping = aes(x=date_bin, y=proportion, 
                     color=subreddit,
                     group=interaction(type, subreddit)
                     )
       ) +
        geom_point(size = 12, alpha = .8, aes(shape=type)) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        scale_shape_manual(values = c(19, 17, 15)) +
        xlab(NULL) +
        ylab("Proportion of Contributors") +
        ylim(0, 100) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box = 'vertical',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:', shape='Degree of Contribution:')
```

```{r, include=FALSE}
#ggsave("output/degree-of-contribution.png", width = 16, height = 9)
```

## Figure 4. Response Rate in r/Teachers and r/education over Time

```{r table3, include=TRUE, echo=FALSE}
## have to subtract 1 to account for NA rows for n_threads and n_responses
table4_teachers <- merged_teachers %>% 
        group_by(post_semester) %>% 
        summarize(n_posts_teachers = length(unique(post_id)),
                  n_threads_teachers = length(unique(thread_id)) - 1,
                  n_responses_teachers = length(unique(response_id)) - 1,
                  n_nonzero_teachers = n_posts_teachers - length(which(is.na(response_text)))
                  ) %>%
        mutate(response_rate_teachers = round((100 * n_nonzero_teachers / n_posts_teachers), 2),
               responses_per_thread_teachers = round((n_responses_teachers / n_threads_teachers), 2)
               ) %>%
        select(post_semester, 
               n_posts_teachers, n_threads_teachers, n_responses_teachers, 
               response_rate_teachers, responses_per_thread_teachers) %>%
        rename(semester=post_semester)
table4_education <- merged_education %>% 
        group_by(post_semester) %>% 
        summarize(n_posts_education = length(unique(post_id)),
                  n_threads_education = length(unique(thread_id)) - 1,
                  n_responses_education = length(unique(response_id)) - 1,
                  n_nonzero_education = n_posts_education - length(which(is.na(response_text)))
                  ) %>%
        mutate(response_rate_education = round((100 * n_nonzero_education / n_posts_education), 2),
               responses_per_thread_education = round((n_responses_education / n_threads_education), 2)
               ) %>%
        select(post_semester, 
               n_posts_education, n_threads_education, n_responses_education, 
               response_rate_education, responses_per_thread_education) %>%
        rename(semester=post_semester)

table4 <- table4_teachers %>% full_join(table4_education, by='semester') %>%
        select(semester, 
               response_rate_teachers, response_rate_education,
               responses_per_thread_teachers, responses_per_thread_education)
table4_kable <- table4 %>% 
        knitr::kable(align='c',
                     col.names=c("Year", 
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation")
                     ) %>% 
        kable_styling(c("striped", "bordered")) %>%
        add_header_above(c(" " = 1, "Response Rate %" = 2, "Responses per Thread" = 2))
#save_kable(table4_kable, "output/table4.png")  # requires webshot::install_phantomjs()
table4_kable
```

```{r response-rate, include=TRUE, echo=FALSE}
tidy_table4 <- table4 %>% 
        select(-starts_with("responses_per_thread")) %>%
        pivot_longer(cols = -semester, 
                     names_to = c("subreddit"),
                     names_pattern = "response_rate_(.*)",
                     values_to = "proportion"
                     ) %>%
        mutate(date_bin = ifelse(semester==2016.1, "2016-Jan-Jun",
                                 ifelse(semester==2016.2, "2016-Jul-Dec",
                                        ifelse(semester==2017.1, "2017-Jan-Jun",
                                               ifelse(semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               )
ggplot(data = tidy_table4, 
       mapping = aes(x=date_bin, y=proportion, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Proportion of Subreddit Threads Receiving a Response") +
        ylim(0, 100) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=24, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE}
#ggsave("output/response-rate.png", width = 16, height = 9)
```

## Figure 5. Thread Lengths in r/Teachers and r/education over Time

```{r thread-length, include=TRUE, echo=FALSE}
tidy_table5 <- table4 %>% 
        select(-starts_with("response_rate")) %>%
        pivot_longer(cols = -semester, 
                     names_to = c("subreddit"),
                     names_pattern = "responses_per_thread_(.*)",
                     values_to = "responses"
                     ) %>%
        mutate(date_bin = ifelse(semester==2016.1, "2016-Jan-Jun",
                                 ifelse(semester==2016.2, "2016-Jul-Dec",
                                        ifelse(semester==2017.1, "2017-Jan-Jun",
                                               ifelse(semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               )
ggplot(data = tidy_table5, 
       mapping = aes(x=date_bin, y=responses, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Mean Number of Responses in Subreddit Threads") +
        ylim(0, 20) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE}
#ggsave("output/thread-length.png", width = 16, height = 9)
```

## Figure 6. Proportion of Self-replies per Thread in r/Teachers and r/education over Time

```{r, include=TRUE, echo=FALSE}
self_responses_teachers <- merged_teachers %>% 
        distinct(post_id, .keep_all = TRUE) %>%
        mutate(subreddit = "teachers",
               date_bin = ifelse(post_semester==2016.1, "2016-Jan-Jun",
                                 ifelse(post_semester==2016.2, "2016-Jul-Dec",
                                        ifelse(post_semester==2017.1, "2017-Jan-Jun",
                                               ifelse(post_semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(post_semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(post_semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        select(date_bin, subreddit, post_id, p_self_responses)
self_responses_education <- merged_education %>% 
        distinct(post_id, .keep_all = TRUE) %>%
        mutate(subreddit = "education",
               date_bin = ifelse(post_semester==2016.1, "2016-Jan-Jun",
                                 ifelse(post_semester==2016.2, "2016-Jul-Dec",
                                        ifelse(post_semester==2017.1, "2017-Jan-Jun",
                                               ifelse(post_semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(post_semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(post_semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        select(date_bin, subreddit, post_id, p_self_responses)
plot_self_responses <- self_responses_teachers %>%
        rbind(self_responses_education) %>% 
        mutate(p_self_responses = as.numeric(p_self_responses))
ggplot(data = plot_self_responses, 
       mapping = aes(x = date_bin, 
                     y = p_self_responses, 
                     color = subreddit, 
                     shape = subreddit,
                     group = subreddit)
       ) +
        geom_point(size = 8, alpha = .8) +
        geom_smooth(method='lm', se=FALSE, size=2, alpha = .8) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        scale_shape_manual(values = c(2, 1)) +
        xlab(NULL) +
        ylab("Proportion of Self-replies per Thread") +
        ylim(0, 100) + 
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE}
#ggsave("output/self-replies.png", width = 16, height = 9)
```

## Figure 7. Transitivity in r/Teachers and r/education over Time

```{r transitivity, include=TRUE, echo=FALSE}
## retrieve the name of the parent author, create edgelist, and then build the network graph
network_graph_teachers <- merged_teachers %>%
        filter(parent_id %in% c(posts_teachers$post_id, 
                                         responses_teachers$thread_id, 
                                         responses_teachers$response_id)) %>%
        mutate(parent_author = ifelse(parent_id %in% merged_teachers$post_id,
                                      post_author,
                                      response_author
                                      )
               ) %>% 
        group_split(post_semester) %>%
        lapply(., function(x) {
                as.data.frame(x) %>% 
                        select(response_author, parent_author)%>%
                        as.matrix() %>%
                        graph_from_edgelist(directed=TRUE) %>% 
                        set_vertex_attr(name='degree', value=degree(., mode='total', loops=FALSE))
                }
               )
#summary(network_graph_teachers[[1]])
network_graph_education <- merged_education %>%
        filter(parent_id %in% c(posts_education$post_id, 
                                         responses_education$thread_id, 
                                         responses_education$response_id)) %>%
        mutate(parent_author = ifelse(parent_id %in% merged_education$post_id,
                                      post_author,
                                      response_author
                                      )
               ) %>% 
        group_split(post_semester) %>%
        lapply(., function(x) {
                as.data.frame(x) %>% 
                        select(response_author, parent_author)%>%
                        as.matrix() %>%
                        graph_from_edgelist(directed=TRUE) %>% 
                        set_vertex_attr(name='degree', value=degree(., mode='total', loops=FALSE))
                }
               )
date_bin <- c("2016-Jan-Jun", "2016-Jul-Dec",
              "2017-Jan-Jun", "2017-Jul-Dec",
              "2018-Jan-Jun", "2018-Jul-Dec", 
              "2019-Jan-Jun")
transitivity_teachers <- sapply(network_graph_teachers, transitivity) %>% round(4)
transitivity_education <- sapply(network_graph_education, transitivity) %>% round(4)
plot_transitivity <- as.data.frame(date_bin) %>%
        cbind(transitivity_teachers) %>%
        cbind(transitivity_education) %>%
        pivot_longer(cols = -date_bin, 
                     names_to = c("subreddit"),
                     names_pattern = "transitivity_(.*)",
                     values_to = "score"
                     )
ggplot(data = plot_transitivity, 
       mapping = aes(x=date_bin, y=score, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Transitivity Score") +
        ylim(0, 0.03) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE}
#ggsave("output/transitivity.png", width = 16, height = 9)
```

## Figure 8. Reciprocity in r/Teachers and r/education over Time

```{r reciprocity, include=TRUE, echo=FALSE}
reciprocity_teachers <- sapply(network_graph_teachers, reciprocity) %>% round(4)
reciprocity_education <- sapply(network_graph_education, reciprocity) %>% round(4)
plot_reciprocity <- as.data.frame(date_bin) %>%
        cbind(reciprocity_teachers) %>%
        cbind(reciprocity_education) %>%
        pivot_longer(cols = -date_bin, 
                     names_to = c("subreddit"),
                     names_pattern = "reciprocity_(.*)",
                     values_to = "score"
                     )
ggplot(data = plot_reciprocity, 
       mapping = aes(x=date_bin, y=score, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Reciprocity Score") +
        ylim(0, 0.008) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE}
#ggsave("output/reciprocity.png", width = 16, height = 9)
```

## Figure 9. Degree of Connectedness in r/Teachers and r/education over Time

```{r degree, include=FALSE}
degrees_teachers_list <- lapply(network_graph_teachers, function(x) {vertex_attr(x, name='degree')})
names(degrees_teachers_list) <- date_bin
degrees_teachers_df <- map_df(degrees_teachers_list, ~ as.data.frame(.x), .id='date_bin') %>%
        rename(degree_teachers = .x) %>%
        pivot_longer(cols = -date_bin, 
                     names_to = c("subreddit"),
                     names_pattern = "degree_(.*)",
                     values_to = "degree"
                     )
#degrees_teachers_df %>% 
#        group_by(date_bin) %>% 
#        summarize(mean = mean(degree),
#                  median = median(degree),
#                  quantile25 = quantile(., .25)
#                  )

degrees_education_list <- lapply(network_graph_education, function(x) {vertex_attr(x, name='degree')})
names(degrees_education_list) <- date_bin
degrees_education_df <- map_df(degrees_education_list, ~ as.data.frame(.x), .id='date_bin') %>%
        rename(degree_education = .x) %>%
        pivot_longer(cols = -date_bin, 
                     names_to = c("subreddit"),
                     names_pattern = "degree_(.*)",
                     values_to = "degree"
                     )
plot_degree <- degrees_teachers_df %>%
        rbind(degrees_education_df) %>% 
        mutate(degree = as.numeric(degree))

ggplot(data = plot_degree, 
       mapping = aes(x = date_bin, 
                     y = degree + 1, 
                     color = subreddit, 
                     shape = subreddit,
                     group = subreddit)
       ) +
        geom_point(size = 8, alpha = .8) +
        geom_smooth(method='lm', se=FALSE, size=2, alpha = .8) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        scale_shape_manual(values = c(2, 1)) +
        xlab(NULL) +
        ylab("Node Degree") +
        scale_y_continuous(trans='log10') + 
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE}
#ggsave("output/degree-node.png", width = 16, height = 9)
```

# Sample posts for qualitative content analysis

Finally, we took a purposeful sample of the Top-10 posts with most responses (or highest voting score) x 7 semesters x 2 subreddits (140 posts + all responses)

```{r sample, include=FALSE}
sample_teachers <- merged_teachers %>%
        distinct(post_id, .keep_all=TRUE) %>%
        group_by(post_semester) %>%
        top_n(n=10, wt=post_voting_score)
sample_education <- merged_education %>%
        distinct(post_id, .keep_all=TRUE) %>%
        group_by(post_semester) %>%
        top_n(n=10, wt=post_voting_score)
sample_unshuffled <- sample_teachers %>% rbind(sample_education)
sample_shuffled <- sample_unshuffled[sample(1:nrow(sample_unshuffled)), ]
#sum(as.numeric(sample_shuffled$num_comments))

#sample_shuffled %>% write.csv("sample_shuffled.csv", row.names=FALSE)

#set.seed(1132020)
#random_sample_teachers <- merged_teachers %>%
#        group_by(post_semester) %>%
#        sample_n(size=10)
```

# Version/dependencies

```{r, session-info}
sessionInfo()
```