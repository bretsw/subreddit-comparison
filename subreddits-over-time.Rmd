---
title: "A Tale of Two Subreddits: Change and Continuity in Teaching-Related Online Spaces"
author: "K. Bret Staudt Willet & Jeffrey P. Carpenter"
date: "06/02/2020"
---

# Get set up

This section loads the data and packages and starts to process the data, but doesn't calculate any statistics or create any results.

```{r setup, include=FALSE}
library(tidyverse)
library(anytime)
library(lubridate)
library(knitr)
library(kableExtra)
library(igraph)
library(ggraph)
library(grid)
library(gridExtra)
library(ggradar)

knitr::opts_chunk$set(echo=TRUE)
usethis::use_git_ignore(c("*.csv", "*.rds", ".log"))
```

```{r set-timeframe, include=FALSE}
date_start <- 
        as_datetime("2016-01-01 05:00:00 UTC") %>% 
        ymd_hms() %>%
        with_tz(tzone="US/Eastern")
date_end <- 
        as_datetime("2019-07-01 03:59:59 UTC") %>% 
        ymd_hms() %>%
        with_tz(tzone="US/Eastern")
```

```{r posts-load, include=FALSE}
posts_teachers0 <- 
        read.csv("data/r-teachers-posts.csv", 
                 header=TRUE, 
                 colClasses='character'
                 ) %>%
        as_tibble()

posts_education0 <- 
        read.csv("data/r-education-posts.csv", 
                 header=TRUE, 
                 colClasses='character'
                 ) %>%
        as_tibble()
```

```{r posts-process, include=FALSE}
posts_teachers <- 
        posts_teachers0 %>%
        rename(post_id = id, 
               post_author = author,
               post_voting_score = score,
               post_text = selftext
               ) %>%
        mutate(post_date_time = created_utc %>% 
                       as.numeric() %>% 
                       anytime(asUTC=TRUE) %>% 
                       as_datetime %>%
                       ymd_hms() %>%
                       with_tz(tzone="US/Eastern"),
               post_voting_score = post_voting_score %>% as.numeric(),
               post_year = year(post_date_time),
               post_semester = semester(post_date_time, with_year=TRUE),
               post_word_count = str_count(title, "\\s+") + 
                       str_count(post_text, "\\s+") + 2
               ) %>%
        distinct(post_id, .keep_all = TRUE) %>%
        filter(post_date_time >= date_start,
               post_date_time <= date_end,
               post_id != "",
               !is.na(post_id),
               post_author != "",
               post_author != "[deleted]",
               post_text != "[deleted]",
               post_text != "[removed]"
               )
rm(posts_teachers0)

posts_education <-
        posts_education0 %>%
        rename(post_id = id, 
               post_author = author,
               post_voting_score = score,
               post_text = selftext
               ) %>%
        mutate(post_date_time = created_utc %>% 
                       as.numeric() %>% 
                       anytime(asUTC=TRUE) %>% 
                       as_datetime %>%
                       ymd_hms() %>%
                       with_tz(tzone="US/Eastern"),
               post_voting_score = post_voting_score %>% as.numeric(),
               post_year = year(post_date_time),
               post_semester = semester(post_date_time, with_year=TRUE),
               post_word_count = str_count(title, "\\s+") + 
                       str_count(post_text, "\\s+") + 2
               ) %>%
        distinct(post_id, .keep_all = TRUE) %>%
        filter(post_date_time >= date_start,
               post_date_time <= date_end,
               post_id != "",
               !is.na(post_id),
               post_author != "",
               post_author != "[deleted]",
               post_text != "[deleted]",
               post_text != "[removed]"
               )
rm(posts_education0)
```

```{r responses-load, include=FALSE}
responses_teachers0 <- 
        read.csv("data/r-teachers-responses.csv", 
                 header=TRUE, 
                 colClasses='character'
                 ) %>%
        as_tibble()

responses_education0 <- 
        read.csv("data/r-education-responses.csv", 
                 header=TRUE, 
                 colClasses='character'
                 ) %>%
        as_tibble()
```

```{r responses-process, include=FALSE}
responses_teachers <- 
        responses_teachers0 %>%
        rename(response_id = id, 
               response_author = author,
               response_voting_score = score,
               response_text = body) %>%
        mutate(thread_id = str_remove(link_id, pattern="t[0-9]_"),
               parent_id = str_remove(parent_id, pattern="t[0-9]_"),
               response_date_time = created_utc %>% 
                       as.numeric() %>% 
                       anytime(asUTC=TRUE) %>% 
                       as_datetime %>%
                       ymd_hms() %>%
                       with_tz(tzone="US/Eastern"),
               post_id = thread_id,
               response_voting_score = response_voting_score %>% as.numeric(),
               response_year = year(response_date_time),
               response_semester = semester(response_date_time, with_year=TRUE),
               response_word_count = str_count(response_text, "\\s+") + 1
               ) %>% 
        distinct(response_id, .keep_all = TRUE) %>%
        filter(response_date_time >= date_start,
               response_date_time <= date_end,
               response_id != "",
               !is.na(response_id),
               response_author != "",
               response_author != "[deleted]",
               response_text != "[deleted]",
               response_text != "[removed]"
               )
rm(responses_teachers0)

responses_education <-
        responses_education0 %>%
        rename(response_id = id, 
               response_author = author,
               response_voting_score = score,
               response_text = body) %>%
        mutate(thread_id = str_remove(link_id, pattern="t[0-9]_"),
               parent_id = str_remove(parent_id, pattern="t[0-9]_"),
               response_date_time = created_utc %>% 
                       as.numeric() %>% 
                       anytime(asUTC=TRUE) %>% 
                       as_datetime %>%
                       ymd_hms() %>%
                       with_tz(tzone="US/Eastern"),
               post_id = thread_id,
               response_voting_score = response_voting_score %>% as.numeric(),
               response_year = year(response_date_time),
               response_semester = semester(response_date_time, with_year=TRUE),
               response_word_count = str_count(response_text, "\\s+") + 1
               ) %>% 
        distinct(response_id, .keep_all = TRUE) %>%
        filter(response_date_time >= date_start,
               response_date_time <= date_end,
               response_id != "",
               !is.na(response_id),
               response_author != "",
               response_author != "[deleted]",
               response_text != "[deleted]",
               response_text != "[removed]"
               )
rm(responses_education0)
```

```{r merged, include=FALSE}
merged_teachers <- 
        posts_teachers %>% 
        left_join(responses_teachers, by=c('post_id')) %>%
        mutate(self_response = ifelse(is.na(response_author), 
                                      FALSE,
                                      ifelse(post_author==response_author, TRUE, FALSE)
                                      )
               ) %>%
        group_by(post_id) %>%
        mutate(n_responses = length(which(!is.na(response_id))),
               n_self_responses = length(which(self_response)), 
               p_self_responses = ifelse(n_responses==0, 
                                         0, 
                                         round(100 * n_self_responses / n_responses, 2)
                                         )
               ) %>%
        ungroup()

merged_education <- 
        posts_education %>% 
        left_join(responses_education, by=c('post_id')) %>%
        mutate(self_response = ifelse(is.na(response_author), 
                                      FALSE,
                                      ifelse(post_author==response_author, TRUE, FALSE)
                                      )
               ) %>%
        group_by(post_id) %>%
        mutate(n_responses = length(which(!is.na(response_id))),
               n_self_responses = length(which(self_response)), 
               p_self_responses = ifelse(n_responses==0, 
                                         0, 
                                         round(100 * n_self_responses / n_responses, 2)
                                         )
               ) %>%
        ungroup()
```

# Analysis and Results

## Figure 1. Daily contributions to r/Teachers and r/education

```{r, include=FALSE, echo=FALSE}
n_months <- 
        (date_end - date_start) %>% 
        time_length(unit="months")
n_posts_overall_teachers <- 
        merged_teachers %>%
        pull(post_id) %>%
        unique() %>%
        length()
n_posts_overall_education <- 
        merged_education %>%
        pull(post_id) %>%
        unique() %>%
        length()
n_responses_overall_teachers <- 
        merged_teachers %>%
        filter(., !is.na(response_id)) %>%
        pull(response_id) %>%
        unique() %>%
        length()
n_responses_overall_education <-
        merged_education %>%
        filter(., !is.na(response_id)) %>%
        pull(response_id) %>%
        unique() %>%
        length()
n_contributions_overall_teachers <- 
        n_posts_overall_teachers + n_responses_overall_teachers
n_contributions_overall_education <- 
        n_posts_overall_education + n_responses_overall_education

n_posters_overall_teachers <- 
        merged_teachers %>%
        pull(post_author) %>%
        unique() %>%
        length()
n_posters_overall_education <- 
        merged_education %>%
        pull(post_author) %>%
        unique() %>%
        length()
n_responders_overall_teachers <- 
        merged_teachers %>%
        filter(., !is.na(response_author)) %>%
        pull(response_author) %>%
        unique() %>%
        length()
n_responders_overall_education <-
        merged_education %>%
        filter(., !is.na(response_author)) %>%
        pull(response_author) %>%
        unique() %>%
        length()
n_contributors_overall_teachers <- 
        merged_teachers %>%
        c(pull(., post_author), pull(., response_author)) %>%
        unique() %>%
        length() -1  # this accounts for the NA response_author
n_contributors_overall_education <- 
        merged_education %>%
        c(pull(., post_author), pull(., response_author)) %>%
        unique() %>%
        length() -1  # this accounts for the NA response_author

#paste0("From the r/Teachers subreddit, we collected ", n_contributions_overall_teachers,  " contributions from ", n_contributors_overall_teachers, " contributors"); paste0("dated between ", date(date_start), " and ", date(date_end), " (", round(n_months, 2), " months),"); paste0("a total of ", n_posts_overall_teachers, " posts and ", n_responses_overall_teachers, " responses to those posts."); paste0("From the r/education subreddit during the same time period, we collected ", n_contributions_overall_education,  " contributions from ", n_contributors_overall_education, " contributors"); paste0("a total of ", n_posts_overall_education, " posts and ", n_responses_overall_education, " responses to those posts.")
```

From the **r/Teachers** subreddit, we collected `r n_contributions_overall_teachers` contributions from `r n_contributors_overall_teachers` contributors dated between `r date(date_start) ` and `r date(date_end)` ( `r round(n_months, 2)` months), a total of `r n_posts_overall_teachers` posts and `r n_responses_overall_teachers` responses to those posts. 

From the **r/education subreddit** during the same time period, we collected `r n_contributions_overall_education` contributions from `r n_contributors_overall_education` contributors, a total of `r n_posts_overall_education` posts and `r n_responses_overall_education` responses to those posts.

In total, `r n_contributions_overall_teachers + n_contributions_overall_education` contributions to these two subreddits comprised our dataset.

```{r contributions-over-time-comparison, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
to_plot_posts_teachers <-
        posts_teachers$post_date_time %>% 
        floor_date("day") %>% 
        as_date() %>%
        table() %>% 
        as_tibble() %>%
        rename(day = ".") %>%
        mutate(day = as_date(day),
               type = "post",
               subreddit = "r/Teachers") %>%
        filter((day >= date_start) & (day <= date_end))
to_plot_responses_teachers <- 
        responses_teachers$response_date_time %>% 
        floor_date("day") %>% 
        as_date() %>%
        table() %>% 
        as_tibble() %>%
        rename(day = ".") %>%
        mutate(day = as_date(day),
               type = "response",
               subreddit = "r/Teachers") %>%
        filter((day >= date_start) & (day <= date_end))
to_plot_posts_education <- 
        posts_education$post_date_time %>% 
        floor_date("day") %>% 
        as_date() %>%
        table() %>% 
        as_tibble() %>%
        rename(day = ".") %>%
        mutate(day = as_date(day),
               type = "post",
               subreddit = "r/education") %>%
        filter((day >= date_start) & (day <= date_end))
to_plot_responses_education <- 
        responses_education$response_date_time %>% 
        floor_date("day") %>% 
        as_date() %>%
        table() %>% 
        as_tibble() %>%
        rename(day = ".") %>%
        mutate(day = as_date(day),
               type = "response",
               subreddit = "r/education") %>%
        filter((day >= date_start) & (day <= date_end))

to_plot <- 
        to_plot_posts_teachers %>% 
        full_join(to_plot_responses_teachers, by = c("subreddit", "day", "type", "n")) %>%
        full_join(to_plot_posts_education, by = c("subreddit", "day", "type", "n")) %>%
        full_join(to_plot_responses_education, by = c("subreddit", "day", "type", "n")) %>%
        mutate(subreddit = as.factor(subreddit),
               type = as.factor(type)
               )

ggplot(data = to_plot, mapping = aes(x=day, y=n, color=subreddit, shape=type)) +
        geom_point(size = 3, alpha=.8) + 
        scale_shape_manual(values = c(17, 3)) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        geom_smooth(method='lm', se=FALSE, size=2) +
        scale_y_continuous(trans='log10') +
        xlab(NULL) +
        ylab("Number of Contributions") +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "gray90"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=24, family='serif'),
              legend.position='bottom',
              legend.box = 'vertical',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit', shape='Type of Contribution:')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig1-contributions-over-time.png", width = 16, height = 9)
```

In addition to this visualization, it is helpful to print the slopes of the linear regressions.

```{r regression-lines, include=FALSE, echo=FALSE}
post_fit_teachers <- 
        to_plot %>% 
        filter(type=='post', subreddit=='r/Teachers') %>% 
        lm(n ~ day, data = .)
post_slope_teachers <- 
        post_fit_teachers$coefficients[[2]] %>% 
        round(2)
post_slope_pval_teachers <- 
        summary(post_fit_teachers)$coef[2,4] %>% 
        round(8)
response_fit_teachers <- 
        to_plot %>% 
        filter(type=='response', subreddit=='r/Teachers') %>% 
        lm(n ~ day, data = .)
response_slope_teachers <- 
        response_fit_teachers$coefficients[[2]] %>% 
        round(2)
response_slope_pval_teachers <- 
        summary(response_fit_teachers)$coef[2,4] %>% 
        round(8)

post_fit_education <- 
        to_plot %>% 
        filter(type=='post', subreddit=='r/education') %>% 
        lm(n ~ day, data = .)
post_slope_education <- 
        post_fit_education$coefficients[[2]] %>% 
        round(2)
post_slope_pval_education <- 
        summary(post_fit_education)$coef[2,4] %>% 
        round(8)
response_fit_education <- 
        to_plot %>% 
        filter(type=='response', subreddit=='r/education') %>% 
        lm(n ~ day, data = .)
response_slope_education <- 
        response_fit_education$coefficients[[2]] %>% 
        round(2)
response_slope_pval_education <- 
        summary(response_fit_education)$coef[2,4] %>% 
        round(8)

#paste0("For the r/Teachers subreddit, the slope of the `post` linear regression is ", post_slope_teachers, " (p=", post_slope_pval_teachers, "),"); paste0("and the slope of the `response` linear regression is ", response_slope_teachers, " (p=", response_slope_pval_teachers, ")."); paste0("For the r/education subreddit, the slope of the `post` linear regression is ", post_slope_education, " (p=", post_slope_pval_education, "),"); paste0("and the slope of the `response` linear regression is ", response_slope_education, " (p=", response_slope_pval_education, ").")
```

For the **r/Teachers** subreddit, the slope of the *post* linear regression is `r post_slope_teachers` (*p* = `r post_slope_pval_teachers`) and the slope of the *response* linear regression is `r response_slope_teachers` (*p* = `r response_slope_pval_teachers`). 

For the **r/education** subreddit, the slope of the *post* linear regression is `r post_slope_education` (*p* = `r post_slope_pval_education`), and the slope of the *response* linear regression is `r response_slope_education` (*p* = `r response_slope_pval_education`).

## Figure 2. Contributors to r/Teachers and r/education

```{r table1, include=TRUE, echo=FALSE}
## have to subtract 1 to account for NA rows for n_responders and n_contributors
table1_teachers <- 
        merged_teachers %>%
        group_by(post_semester) %>% 
        summarize(n_posters_teachers = length(unique(post_author)),
                  n_responders_teachers = length(unique(response_author)) - 1, 
                  n_contributors_teachers = length(unique(c(post_author, 
                                                            response_author))) - 1
                  ) %>%
        rename(semester=post_semester)
table1_education <- 
        merged_education %>%
        group_by(post_semester) %>% 
        summarize(n_posters_education = length(unique(post_author)),
                  n_responders_education = length(unique(response_author)) - 1, 
                  n_contributors_education = length(unique(c(post_author, 
                                                            response_author))) - 1
                  ) %>%
        rename(semester=post_semester)
table1 <- 
        table1_teachers %>% 
        full_join(table1_education, by='semester') %>%
        select(semester, 
               n_contributors_teachers, n_contributors_education,
               n_posters_teachers, n_posters_education,
               n_responders_teachers, n_responders_education
               )
table1_kable <- 
        table1 %>% 
        knitr::kable(align='c',
                     col.names=c("Year", 
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation")
                     ) %>% 
        kable_styling(c("striped", "bordered")) %>%
        add_header_above(c(" " = 1, "Contributors" = 2, "Posters" = 2, "Responders" = 2))
table1_kable
```

```{r, include=FALSE, eval=FALSE}
# requires webshot::install_phantomjs()
save_kable(table1_kable, "output/table1-contributors.png")
```

```{r table1-to-plot, include=FALSE}
table1_to_plot <- 
        table1 %>% 
        select(-n_contributors_teachers, -n_contributors_education) %>%
        pivot_longer(cols = -semester,
                     names_to = c("type", "subreddit"),
                     names_pattern = "n_(.*)_(.*)",
                     values_to = "count"
                     ) %>%
        mutate(date_bin = ifelse(semester==2016.1, "2016-Jan-Jun",
                                 ifelse(semester==2016.2, "2016-Jul-Dec",
                                        ifelse(semester==2017.1, "2017-Jan-Jun",
                                               ifelse(semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        select(-semester) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
               )
```

```{r contributors-plot, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = table1_to_plot, 
       mapping = aes(x=date_bin, 
                     y=count, 
                     color=subreddit,
                     group=interaction(type, subreddit),
                     shape=type
                     )
       ) + 
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        scale_shape_manual(values = c(17, 19)) +
        xlab(NULL) +
        ylab("Number of Contributors") +
        ylim(0, 20000) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box = 'vertical',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:', shape='Type of Contributor:')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig2-contributors.png", width = 16, height = 9)
```

## Degree of Contribution to r/Teachers and r/education

```{r, include=TRUE, echo=FALSE, message=FALSE}
n_multiple_posts_teachers <- 
        merged_teachers %>% 
        group_by(post_semester) %>% 
        count(post_author) %>%
        filter(n > 1) %>% 
        summarize(multiple_posts_teachers = length(n)) %>%
        rename(semester = post_semester)
n_multiple_responses_teachers <- 
        merged_teachers %>% 
        filter(., !is.na(response_author)) %>%
        group_by(post_semester) %>% 
        count(response_author) %>%
        filter(n > 1) %>% 
        summarize(multiple_responses_teachers = length(n)) %>%
        rename(semester = post_semester)
n_self_response_teachers <- 
        merged_teachers %>% 
        filter(., !is.na(response_author)) %>%
        mutate(self_response_numeric = ifelse(self_response, 1, 0)) %>%
        group_by(post_author, post_semester) %>%
        summarize(self_responses_by_poster = sum(self_response)) %>%
        filter(self_responses_by_poster > 0) %>%
        group_by(post_semester) %>%
        summarize(n_with_some_self_responses_teachers = length(self_responses_by_poster)) %>%
        rename(semester = post_semester)
n_multiple_posts_education <- 
        merged_education %>% 
        group_by(post_semester) %>% 
        count(post_author) %>%
        filter(n > 1) %>% 
        summarize(multiple_posts_education = length(n)) %>%
        rename(semester = post_semester)
n_multiple_responses_education <- 
        merged_education %>% 
        filter(., !is.na(response_author)) %>%
        group_by(post_semester) %>% 
        count(response_author) %>%
        filter(n > 1) %>% 
        summarize(multiple_responses_education = length(n)) %>%
        rename(semester = post_semester)
n_self_response_education <- 
        merged_education %>% 
        filter(., !is.na(response_author)) %>%
        mutate(self_response_numeric = ifelse(self_response, 1, 0)) %>%
        group_by(post_author, post_semester) %>%
        summarize(self_responses_by_poster = sum(self_response)) %>%
        filter(self_responses_by_poster > 0) %>%
        group_by(post_semester) %>%
        summarize(n_with_some_self_responses_education = length(self_responses_by_poster)) %>%
        rename(semester = post_semester)

table2 <- table1 %>% 
        full_join(n_multiple_posts_teachers) %>% 
        full_join(n_multiple_posts_education) %>% 
        full_join(n_multiple_responses_teachers) %>%
        full_join(n_multiple_responses_education) %>% 
        full_join(n_self_response_teachers) %>%
        full_join(n_self_response_education) %>%
        mutate(p_multiple_posts_teachers = round(100 * multiple_posts_teachers / 
                                                         n_posters_teachers, 2),
               p_multiple_posts_education = round(100 * multiple_posts_education / 
                                                          n_posters_education, 2),
               p_multiple_responses_teachers = round(100 * multiple_responses_teachers / 
                                                             n_responders_teachers, 2),
               p_multiple_responses_education = round(100 * multiple_responses_education / 
                                                              n_responders_education, 2), 
               p_self_responses_teachers = round(100 * n_with_some_self_responses_teachers / 
                                                        n_responders_teachers, 2),
               p_self_responses_education = round(100 * n_with_some_self_responses_education / 
                                                          n_responders_education, 2)
               ) %>%
        select(semester,
               p_multiple_posts_teachers, p_multiple_posts_education,
               p_multiple_responses_teachers, p_multiple_responses_education,
               p_self_responses_teachers, p_self_responses_education)

table2_kable <- table2 %>% 
        knitr::kable(align='c',
                     col.names=c("Year", 
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation")
                     ) %>% 
        kable_styling(c("striped", "bordered")) %>%
        add_header_above(c(" " = 1, "Multiple Posts Percentage" = 2, 
                           "Multiple Responses Percentage" = 2, "Self-Responses Percentage" = 2))
table2_kable
```

```{r, include=FALSE, eval=FALSE}
save_kable(table2_kable, "output/table2-extent-of-participation.png")
```

```{r table2-to-plot, include=FALSE}
table2_to_plot <- 
        table2 %>% 
        pivot_longer(cols = -semester, 
                     names_to = c("type", "subreddit"),
                     names_pattern = "p_(.*)_(.*)",
                     values_to = "proportion"
                     ) %>%
        mutate(date_bin = ifelse(semester==2016.1, "2016-Jan-Jun",
                                 ifelse(semester==2016.2, "2016-Jul-Dec",
                                        ifelse(semester==2017.1, "2017-Jan-Jun",
                                               ifelse(semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
        )
```

```{r extent-of-contribution-plot, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = table2_to_plot, 
       mapping = aes(x=date_bin, y=proportion, 
                     color=subreddit,
                     group=interaction(type, subreddit)
                     )
       ) +
        geom_point(size = 12, alpha = .8, aes(shape=type)) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        scale_shape_manual(values = c(19, 17, 15)) +
        xlab(NULL) +
        ylab("Percentage of Contributors") +
        ylim(0, 100) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box = 'vertical',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:', shape='Degree of Contribution:')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/extra/extent-of-contribution.png", width = 16, height = 9)
```

## Figure 3. Response Rate in r/Teachers and r/education

```{r table3, include=TRUE, echo=FALSE, message=FALSE}
## have to subtract 1 to account for NA rows for n_threads and n_responses
table3_teachers <- 
        merged_teachers %>% 
        group_by(post_semester) %>% 
        summarize(n_posts_teachers = length(unique(post_id)),
                  n_threads_teachers = length(unique(thread_id)) - 1,
                  n_responses_teachers = length(unique(response_id)) - 1,
                  n_nonzero_teachers = n_posts_teachers - length(which(is.na(response_text)))
                  ) %>%
        mutate(response_rate_teachers = round((100 * n_nonzero_teachers / n_posts_teachers), 2),
               responses_per_thread_teachers = round((n_responses_teachers / n_threads_teachers), 2)
               ) %>%
        select(post_semester, 
               n_posts_teachers, n_threads_teachers, n_responses_teachers, 
               response_rate_teachers, responses_per_thread_teachers) %>%
        rename(semester=post_semester)
table3_education <- merged_education %>% 
        group_by(post_semester) %>% 
        summarize(n_posts_education = length(unique(post_id)),
                  n_threads_education = length(unique(thread_id)) - 1,
                  n_responses_education = length(unique(response_id)) - 1,
                  n_nonzero_education = n_posts_education - length(which(is.na(response_text)))
                  ) %>%
        mutate(response_rate_education = round((100 * n_nonzero_education / n_posts_education), 2),
               responses_per_thread_education = round((n_responses_education / n_threads_education), 2)
               ) %>%
        select(post_semester, 
               n_posts_education, n_threads_education, n_responses_education, 
               response_rate_education, responses_per_thread_education) %>%
        rename(semester=post_semester)

table3 <- 
        table3_teachers %>% 
        full_join(table3_education, by='semester') %>%
        select(semester, 
               response_rate_teachers, response_rate_education,
               responses_per_thread_teachers, responses_per_thread_education)
table3_kable <- 
        table3 %>% 
        knitr::kable(align='c',
                     col.names=c("Year", 
                                 "r/Teachers", "r/edcuation",
                                 "r/Teachers", "r/edcuation")
                     ) %>% 
        kable_styling(c("striped", "bordered")) %>%
        add_header_above(c(" " = 1, "Response Rate %" = 2, "Responses per Thread" = 2))
table3_kable
```


```{r, include=FALSE, eval=FALSE}
save_kable(table3_kable, "output/table3-response-rate.png")  # requires webshot::install_phantomjs()
```

```{r table3_to_plot, include=FALSE}
table3_to_plot <- 
        table3 %>% 
        select(-starts_with("responses_per_thread")) %>%
        pivot_longer(cols = -semester, 
                     names_to = c("subreddit"),
                     names_pattern = "response_rate_(.*)",
                     values_to = "proportion"
                     ) %>%
        mutate(date_bin = ifelse(semester==2016.1, "2016-Jan-Jun",
                                 ifelse(semester==2016.2, "2016-Jul-Dec",
                                        ifelse(semester==2017.1, "2017-Jan-Jun",
                                               ifelse(semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
        )
```

```{r figure3, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = table3_to_plot, 
       mapping = aes(x=date_bin, y=proportion, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Percentage of Subreddit Threads Receiving a Response") +
        ylim(0, 100) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=24, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig3-response-rate.png", width = 16, height = 9)
```

## Figure 4. Thread Lengths in r/Teachers and r/education

```{r, include=FALSE}
table4_to_plot <- 
        table3 %>% 
        select(-starts_with("response_rate")) %>%
        pivot_longer(cols = -semester, 
                     names_to = c("subreddit"),
                     names_pattern = "responses_per_thread_(.*)",
                     values_to = "responses"
                     ) %>%
        mutate(date_bin = ifelse(semester==2016.1, "2016-Jan-Jun",
                                 ifelse(semester==2016.2, "2016-Jul-Dec",
                                        ifelse(semester==2017.1, "2017-Jan-Jun",
                                               ifelse(semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
               )
```

```{r thread-length-plot, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = table4_to_plot, 
       mapping = aes(x=date_bin, y=responses, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Mean Number of Responses in Subreddit Threads") +
        ylim(0, 20) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig4-thread-length.png", width = 16, height = 9)
```

## Percentage of Self-responses per Thread in r/Teachers and r/education

```{r, include=FALSE}
self_responses_teachers <- 
        merged_teachers %>% 
        distinct(post_id, .keep_all = TRUE) %>%
        mutate(subreddit = "teachers",
               date_bin = ifelse(post_semester==2016.1, "2016-Jan-Jun",
                                 ifelse(post_semester==2016.2, "2016-Jul-Dec",
                                        ifelse(post_semester==2017.1, "2017-Jan-Jun",
                                               ifelse(post_semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(post_semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(post_semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        select(date_bin, subreddit, post_id, p_self_responses)
self_responses_education <- 
        merged_education %>% 
        distinct(post_id, .keep_all = TRUE) %>%
        mutate(subreddit = "education",
               date_bin = ifelse(post_semester==2016.1, "2016-Jan-Jun",
                                 ifelse(post_semester==2016.2, "2016-Jul-Dec",
                                        ifelse(post_semester==2017.1, "2017-Jan-Jun",
                                               ifelse(post_semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(post_semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(post_semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        select(date_bin, subreddit, post_id, p_self_responses)
plot_self_responses <- 
        self_responses_teachers %>%
        rbind(self_responses_education) %>% 
        mutate(p_self_responses = as.numeric(p_self_responses)) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
               )
```

```{r self-response-plot, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = plot_self_responses, 
       mapping = aes(x = date_bin, 
                     y = p_self_responses, 
                     color = subreddit, 
                     shape = subreddit,
                     group = subreddit
                     )
       ) +
        geom_point(size = 8, alpha = .8) +
        geom_smooth(method='lm', se=FALSE, size=2, alpha = .8) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        scale_shape_manual(values = c(2, 1)) +
        xlab(NULL) +
        ylab("Percentage of Self-responses per Thread") +
        ylim(0, 100) + 
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              )
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/extra/self-replies.png", width = 16, height = 9)
```

## Figure 5. Node Degree in r/Teachers and r/education

```{r network-setup, include=FALSE}
## retrieve the name of the parent author, create edgelist, and then build the network graph
network_graph_teachers <- 
        merged_teachers %>%
        filter(parent_id %in% c(posts_teachers$post_id, 
                                         responses_teachers$thread_id, 
                                         responses_teachers$response_id)) %>%
        mutate(parent_author = ifelse(parent_id %in% merged_teachers$post_id,
                                      post_author,
                                      response_author
                                      )
               ) %>% 
        group_split(post_semester) %>%
        lapply(., function(x) {
                as.data.frame(x) %>% 
                        select(response_author, parent_author)%>%
                        as.matrix() %>%
                        graph_from_edgelist(directed=TRUE) %>% 
                        set_vertex_attr(name='degree', 
                                        value=degree(., mode='total', loops=FALSE)
                                        )
                }
               )
#summary(network_graph_teachers[[1]])

network_graph_education <- 
        merged_education %>%
        filter(parent_id %in% c(posts_education$post_id, 
                                         responses_education$thread_id, 
                                         responses_education$response_id)) %>%
        mutate(parent_author = ifelse(parent_id %in% merged_education$post_id,
                                      post_author,
                                      response_author
                                      )
               ) %>% 
        group_split(post_semester) %>%
        lapply(., function(x) {
                as.data.frame(x) %>% 
                        select(response_author, parent_author)%>%
                        as.matrix() %>%
                        graph_from_edgelist(directed=TRUE) %>% 
                        set_vertex_attr(name='degree', 
                                        value=degree(., mode='total', loops=FALSE)
                        )
                }
               )
date_bin <- 
        c("2016-Jan-Jun", "2016-Jul-Dec",
          "2017-Jan-Jun", "2017-Jul-Dec",
          "2018-Jan-Jun", "2018-Jul-Dec", 
          "2019-Jan-Jun")
names(network_graph_teachers) <- 
        date_bin
names(network_graph_education) <- 
        date_bin

measure_edges <- function(x){

        }
nodes_te <- map_dbl(network_graph_teachers, function(x) as.vector(length(V(x)))) %>% 
        mean() %>% 
        round(0)
nodes_ed <- map_dbl(network_graph_education, function(x) as.vector(length(V(x)))) %>% 
        mean() %>% 
        round(0)
edges_te <- map_dbl(network_graph_teachers, function(x) as.vector(length(E(x)))) %>% 
        mean() %>% 
        round(0)
edges_ed <- map_dbl(network_graph_education, function(x) as.vector(length(E(x)))) %>% 
        mean() %>% 
        round(0)
#nodes_te; nodes_ed; edges_te; edges_ed
```

```{r degree, include=FALSE}
degrees_teachers_list <- 
        lapply(network_graph_teachers, function(x) {vertex_attr(x, name='degree')})
names(degrees_teachers_list) <- 
        date_bin
degrees_teachers_df <-
        map_df(degrees_teachers_list, ~ as.data.frame(.x), .id='date_bin') %>%
        rename(degree_teachers = .x) %>%
        pivot_longer(cols = -date_bin, 
                     names_to = c("subreddit"),
                     names_pattern = "degree_(.*)",
                     values_to = "degree"
                     )

degrees_education_list <- 
        lapply(network_graph_education, function(x) {vertex_attr(x, name='degree')})
names(degrees_education_list) <- 
        date_bin
degrees_education_df <- 
        map_df(degrees_education_list, ~ as.data.frame(.x), .id='date_bin') %>%
        rename(degree_education = .x) %>%
        pivot_longer(cols = -date_bin, 
                     names_to = c("subreddit"),
                     names_pattern = "degree_(.*)",
                     values_to = "degree"
                     )

plot_degree <- 
        degrees_teachers_df %>%
        rbind(degrees_education_df) %>% 
        mutate(degree = as.numeric(degree)) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
               )
```

```{r degree-plot, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = plot_degree, 
       mapping = aes(x = date_bin, 
                     y = degree + 1, 
                     color = subreddit, 
                     shape = subreddit,
                     group = subreddit)
       ) +
        geom_point(size = 8, alpha = .8) +
        geom_smooth(method='lm', se=FALSE, size=2, alpha = .8) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        scale_shape_manual(values = c(2, 1)) +
        xlab(NULL) +
        ylab("Node Degree") +
        scale_y_continuous(trans='log10') + 
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              )
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/node-degree.png", width = 16, height = 9)
```

```{r mean-degree, include=FALSE}
mean_degrees_teachers_df <-
        degrees_teachers_df %>%
        group_by(date_bin, subreddit) %>%
        summarize(degree = mean(degree))
mean_degrees_education_df <-
        degrees_education_df %>%
        group_by(date_bin, subreddit) %>%
        summarize(degree = mean(degree))
plot_mean_degree <- 
        mean_degrees_teachers_df %>%
        rbind(mean_degrees_education_df) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
               )
```

```{r mean-degree-plot, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = plot_mean_degree, 
       mapping = aes(x=date_bin, 
                     y=degree, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Node Degree") +
        ylim(0, 8) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig5-mean-node-degree.png", width = 16, height = 9)
```

## Figure 6. Transitivity in r/Teachers and r/education

```{r transitivity, include=FALSE}
transitivity_teachers <- 
        sapply(network_graph_teachers, transitivity) %>% 
        round(4)
transitivity_education <- 
        sapply(network_graph_education, transitivity) %>% 
        round(4)
plot_transitivity <- 
        as.data.frame(date_bin) %>%
        cbind(transitivity_teachers) %>%
        cbind(transitivity_education) %>%
        pivot_longer(cols = -date_bin, 
                     names_to = c("subreddit"),
                     names_pattern = "transitivity_(.*)",
                     values_to = "score"
                     ) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
               )
```

```{r transitivity-plot, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = plot_transitivity, 
       mapping = aes(x=date_bin, 
                     y=score, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Transitivity Score") +
        ylim(0, 0.03) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig6-transitivity.png", width = 16, height = 9)
```

## Figure 7. Reciprocity in r/Teachers and r/education

```{r reciprocity, include=FALSE}
reciprocity_teachers <- 
        sapply(network_graph_teachers, reciprocity) %>% 
        round(4)
reciprocity_education <- 
        sapply(network_graph_education, reciprocity) %>% 
        round(4)
plot_reciprocity <- 
        as.data.frame(date_bin) %>%
        cbind(reciprocity_teachers) %>%
        cbind(reciprocity_education) %>%
        pivot_longer(cols = -date_bin, 
                     names_to = c("subreddit"),
                     names_pattern = "reciprocity_(.*)",
                     values_to = "score"
                     ) %>%
        mutate(subreddit = if_else(subreddit == "teachers", 
                                   "r/Teachers",
                                   "r/education"
                                   )
               )
```

```{r reciprocity-plot, include=TRUE, echo=FALSE, fig.width=16, fig.height=9}
ggplot(data = plot_reciprocity, 
       mapping = aes(x=date_bin, 
                     y=score, 
                     color=subreddit,
                     group=subreddit
                     )
       ) +
        geom_point(size = 12, alpha = .8) +
        geom_line(size = 2) +
        scale_color_manual(values = c("#EE442F", "#63ACBE")) + 
        xlab(NULL) +
        ylab("Reciprocity Score") +
        ylim(0, 0.008) +
        theme_bw() +
        theme(panel.grid.major = element_line(color = "gray30"),
              panel.grid.minor = element_line(color = "white"),
              axis.title=element_text(size=28, family='serif'),
              axis.text=element_text(size=18, family='serif'),
              legend.position='bottom',
              legend.box.background = element_rect(),
              legend.title=element_text(size=28, family='serif'), 
              legend.text=element_text(size=24, family='serif')
              ) +
        labs(color='Subreddit:')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig7-reciprocity.png", width = 16, height = 9)
```

## Figure 8. Network Visualizations of r/Teachers and r/education

```{r network-viz-setup, include=FALSE}
remove_isolated <- function(x) {
        delete.vertices(x, which(vertex_attr(x, name='degree')==0))
}

network_teachers_connected <-
        lapply(network_graph_teachers, remove_isolated)
network_education_connected <-
        lapply(network_graph_education, remove_isolated)

network_viz_setup <- function(x) {
        x %>%
        create_layout(layout = 'drl') %>%
        ggraph()
}

network_viz_teachers <- 
        lapply(network_teachers_connected, network_viz_setup)
network_viz_education <- 
        lapply(network_education_connected, network_viz_setup)
```

```{r network-viz, include=FALSE, warning=FALSE}
viz_to_plot <- function(x) {
        x +
                geom_edge_arc(alpha = .2, width = .5, curvature = .3) +
                geom_node_point(alpha = .2, size = 2) +
                theme_void() +
                theme(aspect.ratio = 1)
}

plot_te <- 
        lapply(network_viz_teachers, viz_to_plot)
plot_ed <-
        lapply(network_viz_education, viz_to_plot)
```

```{r, include=FALSE}
plot_te[[1]] <-  
        plot_te[[1]] +
        ggtitle("r/Teachers") +
        ylab("Jan-Jun 2016") + 
        xlab(NULL) +
        theme(plot.title = element_text(size=48, family='serif', hjust = 0.5),
              axis.title=element_text(size=32, family='serif', angle = 90))
plot_te[[4]] <-  
        plot_te[[4]] +
        ylab("Jul-Dec 2017") + 
        xlab(NULL) +
        theme(axis.title=element_text(size=32, family='serif', angle = 90))
plot_te[[7]] <-  
        plot_te[[7]] +
        ylab("Jan-Jun 2019") + 
        xlab(NULL) +
        theme(axis.title=element_text(size=32, family='serif', angle = 90))
plot_ed[[1]] <-
        plot_ed[[1]] + 
        ggtitle("r/education") +
        theme(plot.title = element_text(size=48, family='serif', hjust = 0.5))
```


```{r network-grid-layout, include=TRUE, echo=FALSE, message=FALSE, fig.width=16, fig.height=18}
network_grid_plots <- 
        plot_grid(plot_te[[1]], plot_ed[[1]], 
                  plot_te[[4]], plot_ed[[4]],
                  plot_te[[7]], plot_ed[[7]], 
                  nrow=3)
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig8-network-visualization.png", 
       plot = network_grid_plots, 
       width = 16, height = 18)
```

# Sample posts for qualitative content analysis

Finally, we took a purposeful sample of the Top-10 posts with most responses (or highest voting score) x 7 semesters x 2 subreddits, then up to the Top-10 responses to each (140 posts + up to 1400 responses).

```{r sample, include=FALSE}
top_posts_teachers <- 
        merged_teachers %>%
        distinct(post_id, .keep_all=TRUE) %>%
        group_by(post_semester) %>%
        top_n(n=10, wt=post_voting_score) %>%
        pull(post_id)
sample_teachers <- 
        merged_teachers %>%
        filter(post_id %in% top_posts_teachers) %>%
        group_by(post_id) %>%
        top_n(n=10, wt=response_voting_score) %>%
        select(subreddit.x, post_id, post_date_time, post_voting_score, 
               post_author, title, post_text, response_id, response_date_time, 
               response_voting_score, response_author, response_text,
               n_self_responses, p_self_responses, self_response, url, permalink)

top_posts_education <- 
        merged_education %>%
        distinct(post_id, .keep_all=TRUE) %>%
        group_by(post_semester) %>%
        top_n(n=10, wt=post_voting_score) %>%
        pull(post_id)
sample_education <- 
        merged_education %>%
        filter(post_id %in% top_posts_education) %>%
        group_by(post_id) %>%
        top_n(n=10, wt=response_voting_score) %>%
        select(subreddit.x, post_id, post_date_time, post_voting_score, 
               post_author, title, post_text, response_id, response_date_time, 
               response_voting_score, response_author, response_text,
               n_self_responses, p_self_responses, self_response, url, permalink)
```

```{r save-sample, include=FALSE, eval=FALSE}
write.csv(sample_teachers, "data/sample_teachers.csv", row.names=FALSE)
write.csv(sample_education, "data/sample_education.csv", row.names=FALSE)
```

# Topics and discourse over time (POSTS)

```{r, include=FALSE, message=FALSE, eval=FALSE}
all_coded_with_dates <- read_csv("data/final-coded-sample.csv")
```

## Figure 9. Post Topics and Discourse in r/Teachers and r/education

```{r post_comparison_table, echo=FALSE}
post_comparison <- 
        all_coded_with_dates %>%
        distinct(post_id, .keep_all = TRUE) %>%
        mutate(post_semester = ifelse(post_semester==2016.1, "2016-Jan-Jun",
                                 ifelse(post_semester==2016.2, "2016-Jul-Dec",
                                        ifelse(post_semester==2017.1, "2017-Jan-Jun",
                                               ifelse(post_semester==2017.2, "2017-Jul-Dec",
                                                      ifelse(post_semester==2018.1, "2018-Jan-Jun",
                                                             ifelse(post_semester==2018.2, "2018-Jul-Dec", 
                                                                    "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        group_by(subreddit, post_semester) %>%
        summarize_at(vars(EP_Politics:Asks_Question), sum) %>%
        ungroup()
        
post_comparison_table0 <-
        post_comparison %>%
        select(-subreddit, -post_semester) %>%
        t()
post_comparison_table <-
        post_comparison_table0 %>%
        knitr::kable(align = 'c',
                     row.names = TRUE,
                     col.names = c("2016 Jan-Jun", "2016 Jul-Dec", "2017 Jan-Jun", "2017 Jul-Dec",
                                 "2018 Jan-Jun", "2018 Jul-Dec", "2019 Jan-Jun",
                                 "2016 Jan-Jun", "2016 Jul-Dec", "2017 Jan-Jun", "2017 Jul-Dec",
                                 "2018 Jan-Jun", "2018 Jul-Dec", "2019 Jan-Jun"
                                 )
                     ) %>% 
        kableExtra::add_header_above(c(" " = 1, "r/edcuation" = 7, "r/Teachers" = 7)) %>%
        kableExtra::kable_styling(c("striped", "bordered"))
post_comparison_table
```

```{r include=FALSE, eval=FALSE}
save_kable(post_comparison_table, "output/table4-post-content-comparison-over-time.png")
```

```{r post_comparison_total, echo=FALSE, message=FALSE}
post_comparison_total <-
        post_comparison %>%
        pivot_longer(cols = EP_Politics:Asks_Question, 
                     names_to = "code") %>%
        group_by(subreddit, code) %>%
        summarize(n = sum(value)) %>%
        ungroup() %>%
        pivot_wider(names_from = subreddit, values_from = n) %>%
        column_to_rownames("code") %>%
        knitr::kable(align = 'c',
                     row.names = TRUE,
                     col.names = c("r/education", "r/Teachers")
                     ) %>%
        kableExtra::kable_styling(c("striped", "bordered"))
post_comparison_total
```

```{r include=FALSE, eval=FALSE}
save_kable(post_comparison_total, "output/table5-post-content-comparison-total.png")
```

```{r post_comparison_plot, echo=FALSE, fig.width=16, fig.height=18}
names(post_comparison) <-
        c("subreddit", "post_semester",
          "Ed Policy: Policy Makers & Politics",
          "Ed Policy: School Choice",
          "Ed Policy: Curriculum & Evaluation",
          "Ed Policy: Finance",
          "Ed Policy: Higher Education",
          "Societal Factors Impacting Education",
          "Teaching Pedagogy & Philosophy",
          "Teachers’ Lived Experiences",
          "Title & Hyperlink Only",
          "Personal Story",
          "Humor",
          "Quote",
          "Critique",
          "Call for Change",
          "Question"
          )

post_comparison_to_plot <-
        post_comparison %>%
        pivot_longer(cols = `Ed Policy: Policy Makers & Politics`:Question, 
                     names_to = "code")

post_plot <-
        ggplot(data = post_comparison_to_plot,
               aes(x = code, y = value, fill = subreddit)
               ) +
        geom_col(color = 'black',
                 width = 0.5, 
                 position = position_dodge(width = 0.5)) + 
        scale_fill_manual(values = c("#EE442F", "#63ACBE")) +
        theme_bw() + 
        facet_grid(rows = vars(post_semester))

post_plot + 
        xlab(NULL) +
        ylab("Number of Posts") +
        theme(axis.title = element_text(size = 28, 
                                        family = 'serif'),
              strip.text.y = element_text(size = 16, 
                                          family = 'serif',
                                          angle = 90),
              axis.text.x = element_text(size = 24,
                                         family='serif',
                                         angle = 45, 
                                         vjust = 1, hjust=1),
              axis.text.y = element_text(size = 18, 
                                         family='serif'),
              #axis.ticks.x = element_line(size = 5),
              axis.ticks.length = unit(.25, 'cm'),
              panel.spacing = unit(2, 'lines'),
              legend.position='top',
              legend.box = 'vertical',
              legend.box.background = element_rect(),
              legend.title=element_text(size=32, family='serif'), 
              legend.text=element_text(size=28, family='serif')
              ) +
        labs(fill = 'Subreddit')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig9-post-plot-bar.png", width = 16, height = 18)
```

```{r, echo=FALSE, fig.width=16, fig.height=9}
post_teachers_to_plot <-
        post_comparison_to_plot %>%
        filter(subreddit == "r/Teachers")
post_teachers_plot <-
        ggplot(data = post_teachers_to_plot,
               aes(x = code, y = value, fill = value)
               ) +
        geom_col() + 
        theme_bw() + 
        scale_fill_gradient(low = "#BBF7F9",
                            high = "#63ACBE",
                            limits=c(0,10)) +
        facet_wrap(~ post_semester, nrow = 2)
post_teachers_plot + coord_polar() + theme(axis.text.x = element_text(angle=-20)) 
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/extra/post-teachers-plot-polar.png", width = 16, height = 9)
```       

```{r, echo=FALSE, fig.width=16, fig.height=9}
post_education_to_plot <-
        post_comparison_to_plot %>%
        filter(subreddit == "r/education")
post_education_plot <-
        ggplot(data = post_education_to_plot,
               aes(x = code, y = value, fill = value)
               ) +
        geom_col() + 
        theme_bw() + 
        scale_fill_gradient(low = "#FDBB97",
                            high = "#EE442F",
                            limits=c(0,10)) +
        facet_wrap(~ post_semester, nrow = 2)
post_education_plot + coord_polar() + theme(axis.text.x = element_text(angle=-20)) 
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/extra/post-education-plot-polar.png", width = 16, height = 9)
```    

```{r, echo=FALSE, fig.width=8.5, fig.height=11}
post_radar_list <- list()
for(i in 1:7) {
        post_radar_list[[i]] <- 
                ggradar(post_comparison_to_plot %>%
                        rename(group = subreddit) %>%
                        filter(post_semester == 
                                       unique(.$post_semester)[i]) %>%
                        select(-post_semester) %>%
                        pivot_wider(names_from = code) %>%
                        mutate_at(vars(-group), ~ . / 10), 
                group.colours = c("#EE442F", "#63ACBE"),
                plot.legend = FALSE
                )
}
post_plots_radar <-
        grid.arrange(post_radar_list[[1]], post_radar_list[[2]],
                     post_radar_list[[3]], post_radar_list[[4]],
                     post_radar_list[[5]], post_radar_list[[6]],
                     post_radar_list[[7]],
                     ncol = 2
             )
```   

```{r, include=FALSE, eval=FALSE}
ggsave("output/extra/post-plot-radar.png", plot = post_plots_radar, width = 8.5, height = 11)
``` 

# Topics and discourse over time (RESPONSES)

## Figure 10. Response Topics and Discourse in r/Teachers and r/education

```{r post_comparison_table, echo=FALSE}
response_comparison <- 
        all_coded_with_dates %>%
        distinct(response_id, .keep_all = TRUE) %>%
        mutate(response_semester = ifelse(post_semester==2016.1, "2016-Jan-Jun",
                                          ifelse(post_semester==2016.2, "2016-Jul-Dec",
                                                 ifelse(post_semester==2017.1, "2017-Jan-Jun",
                                                        ifelse(post_semester==2017.2, "2017-Jul-Dec",
                                                               ifelse(post_semester==2018.1, "2018-Jan-Jun",
                                                                      ifelse(post_semester==2018.2, "2018-Jul-Dec", 
                                                                             "2019-Jan-Jun"
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                 )
               ) %>%
        group_by(subreddit, response_semester) %>%
        summarize_at(vars(Agreement:Subreddit_Norms), sum) %>%
        ungroup()
        
response_comparison_table0 <-
        response_comparison %>%
        select(-subreddit, -response_semester) %>%
        t()
row.names(response_comparison_table0) <- 
        c("Expresses Agreement",
          "Expresses Disagreement",
          "Shares Humor",
          "Shares Critique",
          "Shares Personal Story",
          "Provides Additional Information",
          "Gives Advice",
          "Asks Question",
          "Maintains Subreddit Rules & Norms"
          )        
response_comparison_table <-
        response_comparison_table0 %>%
        knitr::kable(align = 'c',
                     row.names = TRUE,
                     col.names = c("2016 Jan-Jun", "2016 Jul-Dec", "2017 Jan-Jun", "2017 Jul-Dec",
                                 "2018 Jan-Jun", "2018 Jul-Dec", "2019 Jan-Jun",
                                 "2016 Jan-Jun", "2016 Jul-Dec", "2017 Jan-Jun", "2017 Jul-Dec",
                                 "2018 Jan-Jun", "2018 Jul-Dec", "2019 Jan-Jun"
                                 )
                     ) %>% 
        kableExtra::add_header_above(c(" " = 1, "r/edcuation" = 7, "r/Teachers" = 7)) %>%
        kableExtra::kable_styling(c("striped", "bordered"))
response_comparison_table
```

```{r include=FALSE, eval=FALSE}
save_kable(response_comparison_table, "output/table6-response-content-comparison-over-time.png")
```

```{r response_comparison_total, echo=FALSE, message=FALSE}
response_comparison_total <-
        response_comparison %>%
        pivot_longer(cols = Agreement:Subreddit_Norms, 
                     names_to = "code") %>%
        group_by(subreddit, code) %>%
        summarize(n = sum(value)) %>%
        ungroup() %>%
        pivot_wider(names_from = subreddit, values_from = n) %>%
        column_to_rownames("code") %>%
        knitr::kable(align = 'c',
                     row.names = TRUE,
                     col.names = c("r/education", "r/Teachers")
                     ) %>%
        kableExtra::kable_styling(c("striped", "bordered"))
response_comparison_total
```

```{r include=FALSE, eval=FALSE}
save_kable(response_comparison_total, "output/table7-response-content-comparison-total.png")
```

```{r response_comparison_plot, echo=FALSE}
response_comparison_to_plot <-
        response_comparison %>%
        pivot_longer(cols = Agreement:Subreddit_Norms, 
                     names_to = "code")
```

```{r response_comparison_plot, echo=FALSE, fig.width=16, fig.height=18}
names(response_comparison) <-
        c("subreddit", "response_semester",
          "Expresses Agreement",
          "Expresses Disagreement",
          "Shares Humor",
          "Shares Critique",
          "Shares Personal Story",
          "Provides Additional Information",
          "Gives Advice",
          "Asks Question",
          "Maintains Subreddit Rules & Norms"
          )

response_comparison_to_plot <-
        response_comparison %>%
        pivot_longer(cols = `Expresses Agreement`:`Maintains Subreddit Rules & Norms`, 
                     names_to = "code")

response_plot <-
        ggplot(data = response_comparison_to_plot,
               aes(x = code, y = value, fill = subreddit)
               ) +
        geom_col(color = 'black',
                 width = 0.5, 
                 position = position_dodge(width = 0.5)) + 
        scale_fill_manual(values = c("#EE442F", "#63ACBE")) +
        theme_bw() + 
        facet_grid(rows = vars(response_semester))

response_plot + 
        xlab(NULL) +
        ylab("Number of Responses") +
        theme(axis.title = element_text(size = 28, 
                                        family = 'serif'),
              strip.text.y = element_text(size = 16, 
                                          family = 'serif',
                                          angle = 90),
              axis.text.x = element_text(size = 24,
                                         family='serif',
                                         angle = 45, 
                                         vjust = 1, hjust=1),
              axis.text.y = element_text(size = 18, 
                                         family='serif'),
              #axis.ticks.x = element_line(size = 5),
              axis.ticks.length = unit(.25, 'cm'),
              panel.spacing = unit(2, 'lines'),
              legend.position='top',
              legend.box = 'vertical',
              legend.box.background = element_rect(),
              legend.title=element_text(size=32, family='serif'), 
              legend.text=element_text(size=28, family='serif')
              ) +
        labs(fill = 'Subreddit')
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/fig10-response-plot-bar.png", width = 16, height = 18)
```

```{r, echo=FALSE, fig.width=16, fig.height=9}
response_teachers_to_plot <-
        response_comparison_to_plot %>%
        filter(subreddit == "r/Teachers")
response_teachers_plot <-
        ggplot(data = response_teachers_to_plot,
               aes(x = code, y = value, fill = value)
               ) +
        geom_col() + 
        theme_bw() + 
        scale_fill_gradient(low = "#BBF7F9",
                            high = "#63ACBE",
                            limits = c(0, 80)) +
        facet_wrap(~ response_semester, nrow = 2)
response_teachers_plot + coord_polar() + theme(axis.text.x = element_text(angle=-20)) 
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/extra/response-teachers-plot-polar.png", width = 16, height = 9)
```       

```{r, echo=FALSE, fig.width=16, fig.height=9}
response_education_to_plot <-
        response_comparison_to_plot %>%
        filter(subreddit == "r/education")
response_education_plot <-
        ggplot(data = response_education_to_plot,
               aes(x = code, y = value, fill = value)
               ) +
        geom_col() + 
        theme_bw() + 
        scale_fill_gradient(low = "#FDBB97",
                            high = "#EE442F",
                            limits = c(0,80)) +
        facet_wrap(~ response_semester, nrow = 2)
response_education_plot + coord_polar() + theme(axis.text.x = element_text(angle=-20)) 
```

```{r, include=FALSE, eval=FALSE}
ggsave("output/extra/response-education-plot-polar.png", width = 16, height = 9)
```   

```{r, echo=FALSE, fig.width=8.5, fig.height=11}
response_radar_list <- list()
for(i in 1:7) {
        response_radar_list[[i]] <- 
                ggradar(response_comparison_to_plot %>%
                        rename(group = subreddit) %>%
                        filter(response_semester == 
                                       unique(.$response_semester)[i]) %>%
                        select(-response_semester) %>%
                        pivot_wider(names_from = code) %>%
                        mutate_at(vars(-group), ~ . / 100), 
                group.colours = c("#EE442F", "#63ACBE"),
                plot.legend = FALSE
                )
}
response_plots_radar <-
        grid.arrange(response_radar_list[[1]], response_radar_list[[2]],
                     response_radar_list[[3]], response_radar_list[[4]],
                     response_radar_list[[5]], response_radar_list[[6]],
                     response_radar_list[[7]],
                     ncol = 2
             )
```   

```{r, include=FALSE, eval=FALSE}
ggsave("output/extra/response-plot-radar.png", plot = response_plots_radar, width = 8.5, height = 11)
```   

# Version/dependencies

```{r session-info}
sessionInfo()
```